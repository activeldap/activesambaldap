#!/usr/bin/env ruby

require 'active_samba_ldap'
require 'active_samba_ldap/command'

argv, opts, options = ActiveSambaLdap::Command.parse_options do |opts, options|
  options.force = false

  opts.banner += " GROUP_NAME"

  opts.on("-f", "--[no-]force",
          "force delete group (#{options.force})") {|options.force|}
end

name = nil
if argv.size == 1
  name = argv.first
else
  $stderr.puts opts
  exit 1
end

unless Process.uid.zero?
  $stderr.puts "need root authority."
  exit 1
end

ActiveSambaLdap::Base.establish_connection("update")

class Group < ActiveSambaLdap::SambaGroup
  ldap_mapping
end

class User < ActiveSambaLdap::SambaUser
  ldap_mapping
end

class Computer < ActiveSambaLdap::SambaComputer
  ldap_mapping
end

unless Group.exists?(name)
  $stderr.puts "group '#{name}' doesn't exist."
  exit 1
end
group = Group.find(name)

begin
  group.destroy(:remove_members => true,
                :force_change_primary_members => options.force)
rescue ActiveSambaLdap::Error
  $stderr.puts $!
  exit 1
end

ActiveSambaLdap::Base.restart_nscd

ActiveSambaLdap::Base.clear_active_connections!
